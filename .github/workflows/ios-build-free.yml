name: ğŸ†“ Free iOS Build (No Apple Developer Account Required)

# âš ï¸ IMPORTANT: This workflow builds iOS apps WITHOUT Apple Developer account
# âœ… Generates .ipa files for testing
# âŒ Cannot install on real iPhone (requires $99/year Apple Developer account)
# âœ… Can test in iOS Simulator
# âœ… Perfect for development and testing

on:
  push:
    branches:
      - main
      - develop
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'simulator'
        type: choice
        options:
          - simulator
          - unsigned-ipa
          - both

jobs:
  build-ios-simulator:
    name: ğŸ¯ Build for iOS Simulator (100% FREE)
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'simulator' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == '' || github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
        
      - name: ğŸ” Verify project structure
        run: |
          echo "Checking iOS project structure..."
          ls -la ios/
          if [ -f "ios/Podfile" ]; then
            echo "âœ… Podfile exists"
          else
            echo "âŒ Podfile missing"
            exit 1
          fi
        
      - name: ğŸ” Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true
        
      - name: ğŸ§ª Run Flutter tests
        run: flutter test
        continue-on-error: true
        
      - name: ğŸ“± Install CocoaPods dependencies
        run: |
          cd ios
          # Update CocoaPods repo
          pod repo update
          # Install dependencies
          pod install --verbose
          # Verify pod installation
          if [ -d "Pods" ]; then
            echo "âœ… CocoaPods installed successfully"
          else
            echo "âŒ CocoaPods installation failed"
            exit 1
          fi
          
      - name: ğŸ› ï¸ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: ğŸ—ï¸ Build iOS App for Simulator
        run: |
          flutter build ios --simulator --debug --verbose
          
      - name: ğŸ“¤ Upload Simulator Build as Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-simulator-build-${{ github.run_number }}
          path: build/ios/iphonesimulator/
          retention-days: 30
          
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ iOS Simulator build completed successfully!"
          echo "ğŸ“± You can test this in iOS Simulator"
          echo "ğŸ’¡ To test: Open Xcode â†’ Window â†’ Devices and Simulators â†’ Run your app"
          echo "ğŸ“¦ Build artifacts uploaded"
          
      - name: âŒ Failure Notification
        if: failure()
        run: echo "âŒ iOS Simulator build failed. Check the logs for details."

  build-ios-unsigned-ipa:
    name: ğŸ“¦ Build Unsigned IPA (For Development)
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'unsigned-ipa' || github.event.inputs.build_type == 'both'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
        
      - name: ğŸ” Verify project structure
        run: |
          echo "Checking iOS project structure..."
          ls -la ios/
          if [ -f "ios/Podfile" ]; then
            echo "âœ… Podfile exists"
          else
            echo "âŒ Podfile missing"
            exit 1
          fi
        
      - name: ğŸ” Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true
        
      - name: ğŸ§ª Run Flutter tests
        run: flutter test
        continue-on-error: true
        
      - name: ğŸ“± Install CocoaPods dependencies
        run: |
          cd ios
          # Update CocoaPods repo
          pod repo update
          # Install dependencies
          pod install --verbose
          # Verify pod installation
          if [ -d "Pods" ]; then
            echo "âœ… CocoaPods installed successfully"
          else
            echo "âŒ CocoaPods installation failed"
            exit 1
          fi
          
      - name: ğŸ› ï¸ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: ğŸ—ï¸ Build iOS App (Debug, No Code Sign)
        run: |
          flutter build ios --debug --no-codesign --verbose
          
      - name: ğŸ“¦ Create IPA file
        run: |
          echo "Creating IPA from build..."
          cd build/ios/iphoneos
          
          # Create Payload directory
          mkdir -p Payload
          
          # Copy app to Payload
          cp -r Runner.app Payload/
          
          # Create IPA (which is just a zip file)
          zip -r ForeverUsInLove-unsigned.ipa Payload/
          
          # Move IPA to root
          mv ForeverUsInLove-unsigned.ipa ../../../
          
          cd ../../../
          
          # Verify IPA was created
          if [ -f "ForeverUsInLove-unsigned.ipa" ]; then
            echo "âœ… IPA created successfully"
            ls -lh ForeverUsInLove-unsigned.ipa
          else
            echo "âŒ IPA creation failed"
            exit 1
          fi
          
      - name: ğŸ“¤ Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-unsigned-ipa-${{ github.run_number }}
          path: ForeverUsInLove-unsigned.ipa
          retention-days: 30
          
      - name: ğŸ“¤ Upload Runner.app as Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-runner-app-${{ github.run_number }}
          path: build/ios/iphoneos/Runner.app
          retention-days: 30
          
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Unsigned iOS build completed successfully!"
          echo "ğŸ“¦ IPA file: ForeverUsInLove-unsigned.ipa"
          echo "âš ï¸  This build CANNOT be installed on real iPhone"
          echo "ğŸ’¡ This is for development and testing purposes only"
          echo "ğŸ” To install on real iPhone, you need:"
          echo "    1. Apple Developer account (\$99/year)"
          echo "    2. Code signing certificates"
          echo "    3. Provisioning profiles"
          echo ""
          echo "ğŸ“¥ Download artifacts from the Actions tab"
          
      - name: âŒ Failure Notification
        if: failure()
        run: echo "âŒ Unsigned iOS build failed. Check the logs for details."
