name: ğŸ†“ Free iOS Build (No Apple Developer Account Required)

# âš ï¸ IMPORTANT: This workflow builds iOS apps WITHOUT Apple Developer account
# âœ… Generates .ipa files for testing
# âŒ Cannot install on real iPhone (requires $99/year Apple Developer account)
# âœ… Can test in iOS Simulator
# âœ… Perfect for development and testing

on:
  push:
    branches:
      - main
      - develop
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'simulator'
        type: choice
        options:
          - simulator
          - unsigned-ipa

jobs:
  build-ios-simulator:
    name: ğŸ¯ Build for iOS Simulator (100% FREE)
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'simulator' || github.event.inputs.build_type == '' || github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
          flutter pub deps
        
      - name: ğŸ” Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true
        
      - name: ğŸ§ª Run Flutter tests
        run: flutter test
        continue-on-error: true
        
      - name: ğŸ“± Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: ğŸ› ï¸ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: ğŸ—ï¸ Build iOS App for Simulator
        run: |
          flutter build ios --simulator --debug
          
      - name: ğŸ“¤ Upload Simulator Build as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: build/ios/iphonesimulator/
          retention-days: 30
          
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ iOS Simulator build completed successfully!"
          echo "ğŸ“± You can test this in iOS Simulator"
          echo "ğŸ’¡ To test: Open Xcode â†’ Window â†’ Devices and Simulators â†’ Run your app"
          
      - name: âŒ Failure Notification
        if: failure()
        run: echo "âŒ iOS Simulator build failed. Check the logs for details."

  build-ios-unsigned-ipa:
    name: ğŸ“¦ Build Unsigned IPA (For Development)
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'unsigned-ipa'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
          flutter pub deps
        
      - name: ğŸ” Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true
        
      - name: ğŸ§ª Run Flutter tests
        run: flutter test
        continue-on-error: true
        
      - name: ğŸ“± Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: ğŸ› ï¸ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: ğŸ—ï¸ Build Unsigned IPA
        run: |
          # Build without code signing (for development only)
          flutter build ios --debug --no-codesign
          
          # Create IPA manually (since we can't use flutter build ipa without signing)
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../ios-unsigned-app.zip Payload/
          cd ../../../
          
      - name: ğŸ“¤ Upload Unsigned Build as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: |
            build/ios/iphoneos/Runner.app
            ios-unsigned-app.zip
          retention-days: 30
          
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Unsigned iOS build completed successfully!"
          echo "âš ï¸  This build CANNOT be installed on real iPhone"
          echo "ğŸ’¡ This is for development and testing purposes only"
          echo "ğŸ” To install on real iPhone, you need Apple Developer account ($99/year)"
          
      - name: âŒ Failure Notification
        if: failure()
        run: echo "âŒ Unsigned iOS build failed. Check the logs for details."

  # Optional: Build for multiple iOS versions
  build-multiple-ios-versions:
    name: ğŸ”„ Build for Multiple iOS Versions
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'multi-version'
    strategy:
      matrix:
        ios-version: ['15.0', '16.0', '17.0']
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
          flutter pub deps
        
      - name: ğŸ“± Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: ğŸ› ï¸ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: ğŸ—ï¸ Build for iOS ${{ matrix.ios-version }}
        run: |
          flutter build ios --simulator --debug --target-platform ios --ios-version ${{ matrix.ios-version }}
          
      - name: ğŸ“¤ Upload Build for iOS ${{ matrix.ios-version }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.ios-version }}-build
          path: build/ios/iphonesimulator/
          retention-days: 30