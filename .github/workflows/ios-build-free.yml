name: 🆓 Free iOS Build (No Apple Developer Account Required)

# ⚠️ IMPORTANT: This workflow builds iOS apps WITHOUT Apple Developer account
# ✅ Generates .ipa files for testing
# ❌ Cannot install on real iPhone (requires $99/year Apple Developer account)
# ✅ Can test in iOS Simulator
# ✅ Perfect for development and testing

on:
  push:
    branches:
      - main
      - develop
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente
    inputs:
      build_type:
        description: 'Tipo de build'
        required: true
        default: 'simulator'
        type: choice
        options:
          - simulator
          - unsigned-ipa

jobs:
  build-ios-simulator:
    name: 🎯 Build for iOS Simulator (100% FREE)
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'simulator' || github.event.inputs.build_type == '' || github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        
      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'
          cache: true
          
      - name: 📦 Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
          flutter pub deps
        
      - name: 🔍 Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true
        
      - name: 🧪 Run Flutter tests
        run: flutter test
        continue-on-error: true
        
      - name: 📱 Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: 🛠️ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: 🏗️ Build iOS App for Simulator
        run: |
          flutter build ios --simulator --debug
          
      - name: 📤 Upload Simulator Build as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: build/ios/iphonesimulator/
          retention-days: 30
          
      - name: ✅ Success Notification
        if: success()
        run: |
          echo "🎉 iOS Simulator build completed successfully!"
          echo "📱 You can test this in iOS Simulator"
          echo "💡 To test: Open Xcode → Window → Devices and Simulators → Run your app"
          
      - name: ❌ Failure Notification
        if: failure()
        run: echo "❌ iOS Simulator build failed. Check the logs for details."

  build-ios-unsigned-ipa:
    name: 📦 Build Unsigned IPA (For Development)
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'unsigned-ipa'
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        
      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'
          cache: true
          
      - name: 📦 Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
          flutter pub deps
        
      - name: 🔍 Run Flutter analyzer
        run: flutter analyze
        continue-on-error: true
        
      - name: 🧪 Run Flutter tests
        run: flutter test
        continue-on-error: true
        
      - name: 📱 Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: 🛠️ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: 🏗️ Build Unsigned IPA
        run: |
          # Build without code signing (for development only)
          flutter build ios --debug --no-codesign
          
          # Create IPA manually (since we can't use flutter build ipa without signing)
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../ios-unsigned-app.zip Payload/
          cd ../../../
          
      - name: 📤 Upload Unsigned Build as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: |
            build/ios/iphoneos/Runner.app
            ios-unsigned-app.zip
          retention-days: 30
          
      - name: ✅ Success Notification
        if: success()
        run: |
          echo "🎉 Unsigned iOS build completed successfully!"
          echo "⚠️  This build CANNOT be installed on real iPhone"
          echo "💡 This is for development and testing purposes only"
          echo "🔐 To install on real iPhone, you need Apple Developer account ($99/year)"
          
      - name: ❌ Failure Notification
        if: failure()
        run: echo "❌ Unsigned iOS build failed. Check the logs for details."

  # Optional: Build for multiple iOS versions
  build-multiple-ios-versions:
    name: 🔄 Build for Multiple iOS Versions
    runs-on: macos-latest
    if: github.event.inputs.build_type == 'multi-version'
    strategy:
      matrix:
        ios-version: ['15.0', '16.0', '17.0']
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        
      - name: 🚀 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'
          cache: true
          
      - name: 📦 Get Flutter dependencies
        run: |
          flutter --version
          flutter doctor -v
          flutter pub get
          flutter pub deps
        
      - name: 📱 Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: 🛠️ Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: 🏗️ Build for iOS ${{ matrix.ios-version }}
        run: |
          flutter build ios --simulator --debug --target-platform ios --ios-version ${{ matrix.ios-version }}
          
      - name: 📤 Upload Build for iOS ${{ matrix.ios-version }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.ios-version }}-build
          path: build/ios/iphonesimulator/
          retention-days: 30